---
title: "Linkedin-US"
author: "Luisa M Mimmi"
date: "November 30, 2017"
output: html_document
---

---
title: "LinkedIn & IFC study of migration"
author: "Luisa M Mimmi"
date: "November 24, 2017"
output:
  html_document: default
  pdf_document: default
  word_document: default
  
---

# 1 CONCEPTUAL FRAMEWORK

A city's productivity can be  simply defined as the net result of contrasting forces $\ Productivity = Agglomeration (positive) - Congestion (negative)$ 

Where $\ Agglomeration$ and $\ Congestion$ are a function of various dimensions $\ = f(Skills, Amenities, Form, Access)$

* Dimensions
    + **Skills**, a city’s aggregate stock of human capital
    + **Amenities** - _attracting skills_ - job opportunities, housing values, cultural attractions
    + **Form**, the size and spatial configuration of a city (*density* vs. *sprawl*, *wider metropolitan areas*)
    + **Access**, a city’s connectedness (or barriers) to other cities, both_USA at home and abroad, through the transportation network

* This comparative analysis will focus on the first dimension **Skills**, with hints to the other ones


```{r packages , results='hide', warning=FALSE, message = FALSE}

library(ggplot2) # install.packages("ggplot2")
library(dplyr)
library(knitr)
library(datasets) # initialize
library (knitr)
library(kableExtra)
library(stats)
library(tidyr)
```

```{r data , results='hide', warning=FALSE, message = FALSE}
getwd()
migr <- read.csv("migration.csv",fileEncoding="UTF-8-BOM")
demog <- read.csv("demographics.csv",fileEncoding="UTF-8-BOM")
```

# 2 DATA EXPLORATION BY COUNTRY



United States

#### Merge the 2 tables 
```{r }
both <- left_join(demog,migr, by="NEW_MEM_ID")

# select only USA
both_USA <- both %>% filter(SOURCE_COUNTRY=="United States" & DESTINATION_COUNTRY=="United States")
        # both_USA_USA <- subset(both_USA, SOURCE_COUNTRY=="United States" & DESTINATION_COUNTRY=="United States")
        # both_USA_USA <- subset(both_USA, SOURCE_COUNTRY=="United States" & DESTINATION_COUNTRY=="United States")




# select only Australia
both_AUS <- both %>% filter(SOURCE_COUNTRY=="Australia" & DESTINATION_COUNTRY=="Australia")

# select only UK
both_UK <- both %>% filter(SOURCE_COUNTRY=="United Kingdom" & DESTINATION_COUNTRY=="United Kingdom")

```


# some
```{r}
# just a few
both_USA_N <- both_USA %>% group_by(DESTINATION_REGION) %>%  summarise(numIMM = n())
both_USA_N

some_USA <- both_USA[both_USA$DESTINATION_REGION == "Greater New York City Area" | both_USA$DESTINATION_REGION == "San Francisco Bay Area"  | both_USA$DESTINATION_REGION == "Washington D.C. Metro Area" | both_USA$DESTINATION_REGION == "Greater Los Angeles Area" | both_USA$DESTINATION_REGION == "Greater Boston Area"| both_USA$DESTINATION_REGION == "Greater Seattle Area" | both_USA$DESTINATION_REGION =="Austin, Texas Area" | both_USA$DESTINATION_REGION =="Miami/Fort Lauderdale Area"| both_USA$DESTINATION_REGION =="Hawaiian Islands" | both_USA$DESTINATION_REGION =="Savannah, Georgia Area" 
                    | both_USA$DESTINATION_REGION == "Green Bay, Wisconsin Area" | both_USA$DESTINATION_REGION =="St. Cloud, Minnesota Area" | both_USA$DESTINATION_REGION =="Greenville, North Carolina Area"| both_USA$DESTINATION_REGION =="Houston, Texas Area" | both_USA$DESTINATION_REGION =="Savannah, Georgia Area" 
                    ,  ]


```


## 2.b Frequencies and Proportions 
I'm interested in studying members distribution across categorical variables according to origin country


* **INSIGHTs**: 
    + US has a significantly higher # of Associates leaving (18% vs 3% and 4%)
    + Proportions seem remarkably similar in terms of Seniority / Sector / Position across countries of ORIGIN
    + At the country level there are no big differences... probably makes more sense looking at city or internally
    + Wonder if this is a subset of real Linkedin members or if there are particular similarities in the English-speaking countries
   


   


# 3 DATA EXPLORATION BY CITY

#### interim manipulation 
```{r , results='hide', warning=FALSE, message = FALSE}
# create origin table
origin_USA <- both_USA %>% select(id=NEW_MEM_ID, degree=HIGHEST_DEGREE_OBTAINED, seniority=SENIORITY, sector=EMPLOYER_INDUSTRY_SECTOR, role=POSITION_FUNCTION, date=WEEK_BEGINNING, countryO=SOURCE_COUNTRY, cityO=SOURCE_REGION)

# create destination table
destination <- both_USA %>% select(id=NEW_MEM_ID, degree=HIGHEST_DEGREE_OBTAINED, seniority=SENIORITY, sector=EMPLOYER_INDUSTRY_SECTOR, role=POSITION_FUNCTION, date=WEEK_BEGINNING, countryD=DESTINATION_COUNTRY, cityD=DESTINATION_REGION)
```


## 3.1 Top 10 cities  (US)
```{r}
# Aggregate N flow (OUT) by City
library (knitr)
library(kableExtra)
aggreOrig <- origin_USA  %>% 
  group_by(cityO) %>% 
  summarize(NumOutflow= n())  %>% 
  mutate(freq = NumOutflow / sum(NumOutflow)) %>%
  mutate(rel.freq = as.numeric(paste0(round(100 * NumOutflow/sum(NumOutflow), 3))))  %>% 
  arrange(desc(NumOutflow))

# Top 10 ORIGIN cities  
aggreOrig_short <- aggreOrig[1:10,]  
kable(aggreOrig_short, format = "html", caption = "Ranking of cities by Origin") %>%  kable_styling(bootstrap_options = c("striped", "hover", full_width = T , position = "center",font_size = NULL))

# create destination table
destination <- both_USA %>% select(id=NEW_MEM_ID, degree=HIGHEST_DEGREE_OBTAINED, seniority=SENIORITY, sector=EMPLOYER_INDUSTRY_SECTOR, role=POSITION_FUNCTION, date=WEEK_BEGINNING, countryD=DESTINATION_COUNTRY, cityD=DESTINATION_REGION)


# Aggregate N flow (IN) by City
 library (knitr)
library(kableExtra)
aggreDest <- destination  %>% 
  group_by(cityD) %>% 
  summarize(NumInflow= n())  %>% 
  mutate(freq = NumInflow / sum(NumInflow)) %>%
  mutate(rel.freq = as.numeric(paste0(round(100 * NumInflow/sum(NumInflow), 3))))  %>% 
  arrange(desc(NumInflow))

# Top 10 DESTINATION cities
aggreDest_short <- aggreDest[1:10,]  
kable(aggreDest_short, format = "html", caption = "Ranking of cities by popular destination") %>% kable_styling(bootstrap_options = c("striped", "hover", full_width = T , position = "center",font_size = NULL))
```
* **INSIGHTs**: 
    + Intristingly, London is # 5 Origin but # 10 Destination
    + 9/10 top DESTINATION are the same as top ORIGIN which suggest there is mobility, but not necessarily the top destination are places where people stay
    + this can be explained by the American way of moving to and from the city of college
    + _those where all american !!!_


* **INSIGHTs**: 
    + Similar to UK, in Australiam Sydney is the origin of 36% of migrants and the Destination for 50% of them 



## 3.4 Plots of top cities 

#### JOIN the AGGREGATE by CITY to have Net flows in the same table (by City) 
```{r , results='hide', warning=FALSE, message = FALSE}
# Adding some variables for plots  
aggreByCity <- full_join(aggreDest,aggreOrig, by = c("cityD" = "cityO")) 
aggreByCity[c("NumInflow", "NumOutflow")][is.na(aggreByCity[c("NumInflow", "NumOutflow")])] <- 0

aggreByCity <-  aggreByCity %>% 
  select(-freq.x,-rel.freq.x, -freq.y, -rel.freq.y) %>%  # get rid of meeaningless 
  mutate (NetFlow= NumInflow -NumOutflow) %>% # Net 
  mutate (NegOutFlow= -(NumOutflow)) %>% # neg sign 
  mutate (Sign = ifelse(NetFlow > 0, "Positive", "Negative")) %>%
  mutate (colour= ifelse(NetFlow > 0, "positive", "negative"))

summary(aggreByCity)

library(ggplot2)
require(ggplot2)
library(stats)


```


#### interim 
```{r}
# ====================== INTERIM ======================= #
names(aggreByCity)[1]<-"city"
names(migr)[4]<-"city"
# city_country <-full_join(aggreByCity, migr, by = c("city", "SOURCE_REGION")) %>%  # #select(city,country=origCountry)

city_country <-full_join(aggreByCity, migr, by = "city") %>%  
  select(city, country=DESTINATION_COUNTRY) %>%
  distinct () %>% # need the dup flag 
  mutate(dupli = ifelse((city =="Greater New York City Area"|city =="San Francisco Bay Area" |city =="Washington D.C. Metro Area"|
  city =="Greater Los Angeles Area"|city =="Greater Boston Area"|city =="Greater Chicago Area" |
  city =="Dallas/Fort Worth Area" |city =="Greater Seattle Area" |city =="San Francisco Bay Area") & country!="United States", "dup", "")) %>% # need the dup flag 
  
  mutate(dupli2 = ifelse((city =="London, United Kingdom") & country!="United kindom", "dup", "")) %>% # need the dup flag 
  
  mutate(dupli3 = ifelse((city =="Sydney Area, Australia") & country!="Australia", "dup", "")) %>% # need the dup flag 
  
  mutate(dupli4 = ifelse((city =="Perth Area, Australia") & country!="Australia", "dup", "")) %>% # need the dup flag 
  
  mutate(dupli5 = ifelse((city =="Miami/Fort Lauderdale Area") & country!="United States", "dup", "")) %>% # need the dup flag 
  
  mutate(dupli6 = ifelse((city =="Brisbane Area, Australia") & country!="Australia", "dup", "")) 


city_country <- subset(city_country, city_country$dupli!="dup" & city_country$dupli2!="dup" & city_country$dupli3!="dup" & city_country$dupli4!="dup" & city_country$dupli5!="dup" & city_country$dupli6!="dup") %>% select(city, country)


newRow <- data.frame(city ="London, United Kingdom", country ="United Kingdom" )

city_country <- rbind(city_country,newRow)
#city_country <- rbind(city_country, c("London, United Kingdom", "United kindom"))
  
names(aggreByCity)[1]<-"cityD"
# ===================================================== #
```


###  Major 30 (World - mostly US) cities TO people are migrating 

```{r}
names(aggreByCity)[1]<-"city"

# 1) In  Flow in Top DESTINATION 
Top_in <- aggreByCity %>% top_n(30, NumInflow)  
  Top_in$city = with(Top_in, reorder(city,NumInflow)) # reorder Levels by Var

Top_in <- ggplot(data = Top_in,aes(city, NumInflow)) + 
  geom_bar(stat = "identity", position="identity", fill = "steelblue") +
  geom_hline(yintercept=10000, color = "black", size=0.5) +
  theme(axis.text.x = element_text(angle=60, vjust=0.3), axis.text.y = element_text(size=10,face="bold") ) + 
  labs(title="IN migration flow in first 15 destination")


Top_in + coord_flip()

# 2) Out  Flow in Top ORIGIN 
Top_out <- aggreByCity %>% top_n(30, NumOutflow)  
  Top_out$city = with(Top_out, reorder(city,NumOutflow)) # reorder Levels by Var

Top_out <- ggplot(data = Top_out,aes(city, NegOutFlow)) + 
  geom_bar(stat = "identity", position="identity", fill = "firebrick1") + 
   geom_hline(yintercept=-10000, color = "black", size=0.5) +
  theme(axis.text.x = element_text(angle=60, vjust=0.3), axis.text.y = element_text(size=10,face="bold") ) + 
  labs(title="OUT migration flow in first 15 origin") 
  
Top_out + coord_flip()

# 3.a)  NET flow in Top  DESTINATION 
Top_net <- aggreByCity %>% top_n(30, NumInflow)  
  Top_net$city = with(Top_net, reorder(city,NumInflow)) # reorder Levels by Var

Top_net <- ggplot(data = Top_net,aes(city, NetFlow)) + 
  geom_bar(stat = "identity", position="identity",aes(fill = colour)) + 
  theme(axis.text.x = element_text(angle=60, vjust=0.3), axis.text.y = element_text(size=10,face="bold") ) + 
  scale_fill_manual(values=c(positive="steelblue",negative="firebrick1")) +
  labs(title="NET migration flow in first 25 destination", subtitle="(ordered by destination)")
Top_net + coord_flip()

# 3.b)  NET flow in Top  ORIGIN 
Top_net <- aggreByCity %>% top_n(30, NumOutflow)  
  Top_net$city = with(Top_net, reorder(city,NumOutflow)) # reorder Levels by Var

Top_net <- ggplot(data = Top_net,aes(city, NetFlow)) + 
  geom_bar(stat = "identity", position="identity",aes(fill = colour)) + 
  theme(axis.text.x = element_text(angle=60, vjust=0.3), axis.text.y = element_text(size=10,face="bold") ) + 
  scale_fill_manual(values=c(positive="steelblue",negative="firebrick1")) +
  labs(title="NET migration flow in first 25 origin", subtitle="(ordered by origin)")
Top_net + coord_flip()


# all american
# lots of leaving in 2016 - especially in NY 

```




```{r}
# add country to aggreByCity
aggreByCity2 <- left_join(aggreByCity,city_country,by = "city")

# x[c("a", "b")][is.na(x[c("a", "b")])] <- 0
aggreByCity2[c("NumInflow", "NumOutflow")][is.na(aggreByCity2[c("NumInflow", "NumOutflow")])] <- 0


```


* **INSIGHTs**: 
    + Contrary to US, London is a definitive outlier
  


# 4 BIVARIATE MEASURES OF ASSOCIATION

## 4.1 INflow by city vs highest degree
Is there any relation between where they choose to go and the highest degree they have? I use plots to check  distributions type of DEGREE (Y) conditional on  the city of destination (X) 

* I check for :
    + *Existence*
    + *strnght*
    + *patterns* / direction 



Greater New York City Area
San Francisco Bay Area
Washington D.C. Metro Area

Manchester, United Kingdom
London, United Kingdom
Birmingham, United Kingdom

Sydney Area, Australia
Brisbane Area, Australia
Canberra Area, Australia



* **INSIGHTs**: 
    + Intuitively, it would seem San Francisco (follwed by Canberra) attracts the highest amount of doctors (Canberra also the highest group with master) 
    + NY, San Francisco and Washington DC seem to receive many with "Associate" level: either young people go tehre to look for tehir first job
    

```{r}
# cramer v   degree  X CITY OF DESTINATION (top 3)
x<- both_USA$DESTINATION_REGION
y<- both_USA$HIGHEST_DEGREE_OBTAINED

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  print.noquote("Cramér V / Phi:")
  return(as.numeric(CV))
}

with(both_USA, cv.test(x, y)) # [1] Cramér V / Phi: 0.09052046 -> USA 0.1275029
```



```{r ,fig.width=7, fig.height=7}
#
# mosaicplot(table(some_USA$DESTINATION_REGION, some_USA$SENIORITY), ylab = "Political Party", xlab = "Tax Reform Bill Opinion", main = "Opinion vs Party",          color = c("purple", "forestgreen"))

# qplot
qplot(x = DESTINATION_REGION, data = some_USA, fill = SENIORITY, geom = "bar") +
theme(axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
  labs(title="SENIORITY across top 3 city in 3 countries")

# Test statistic (assuming indipendence)
chisq <- chisq.test(x = table(some_USA$DESTINATION_REGION, some_USA$SENIORITY), correct = FALSE)
chisq

# ggplot
ggplot(some_USA, aes(x=DESTINATION_REGION, y=NEW_MEM_ID, fill=SENIORITY)) +  geom_bar(aes(colour =SENIORITY),stat="identity", position = "fill") +
theme(axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
  labs(title="SENIORITY across top 3 city in 3 countries")


```
* **INSIGHTs**: 
    + Intuitively, it would seem San Francisco (follwed by Canberra) attracts the highest amount of doctors (Canberra also the highest group with master) 
    + NY, San Francisco and Washington DC seem to receive many with "Associate" level: either young people go tehre to look for tehir first job
```{r}
# cramer v   SENIORITY   X CITY OF DESTINATION (top 3)
x<- some_USA$DESTINATION_REGION
y<- some_USA$SENIORITY

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  print.noquote("Cramér V / Phi:")
  return(as.numeric(CV))
}

with(some_USA, cv.test(x, y)) # [1] Cramér V / Phi: 0.04360073
```  

```{r ,fig.width=7, fig.height=7}
#
# mosaicplot(table(some_USA$DESTINATION_REGION, some_USA$EMPLOYER_INDUSTRY_SECTOR), ylab = "Political Party", xlab = "Tax Reform Bill Opinion", main = "Opinion vs Party",          color = c("purple", "forestgreen"))

# qplot
qplot(x = DESTINATION_REGION, data = some_USA, fill = EMPLOYER_INDUSTRY_SECTOR, geom = "bar") +
theme(axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
 labs(title="EMPLOYER_INDUSTRY_SECTOR across top 3 city in 3 countries", x="", y="Number of people coming in")



# ggplot
library(RColorBrewer)
# display.brewer.all()

ggplot(some_USA, aes(x=DESTINATION_REGION, y=NEW_MEM_ID, fill=EMPLOYER_INDUSTRY_SECTOR)) +  
  geom_bar(aes(colour =EMPLOYER_INDUSTRY_SECTOR),stat="identity",  position = "fill") +
theme(legend.position = "right"    ,axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
  
   # scale_fill_brewer(palette = "Dark2") +
  # scale_fill_grey() +
  labs(title="EMPLOYER_INDUSTRY_SECTOR across top 3 city in 3 countries", x="", y="Number of people coming in normalized")
```

* **INSIGHTs**: 
    + Intuitively, share of immigratns by sector seems to vary a lot in different cities
    + Extremely high number in Govv/ Educ/ Non Profit in Canberra & Washington
    + Extremely high number in Software + Hardware Technology in San Francisco
    + Extremely high number in Govv/ Educ/ Non Profit + Financial sErvices also in NY
    it would seem San Francisco (follwed by Canberra) attracts the highest amount of doctors (Canberra also the highest group with master) 
    + NY, San Francisco and Washington DC seem to receive many with "Associate" level: either young people go tehre to look for tehir first job
  
  
### CHECK A COUPLE OF CITIES FOR SECTOR X SEIORITY
```{r}
freq_OrigDegree <- both_USA %>%
  group_by(both_USA[,7],both_USA[,2]) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))
freq_OrigDegree  # US has a significantly higher # of Associates leaving (18% vs 3% and 4%)
```

##### Cramer's V
 a measure of association for nominal variables. Effectively it is the Pearson chi-square statistic rescaled to have values between 0 and 1, as follows:

$\ V = sqrt(X^2 / [nobs * (min(ncols, nrows) – 1)]) $

where X^2 is the Pearson chi-square, nobs represents the number of observations included in the table, and where ncols and nrows are the number of rows and columns in the table, respectively.

For a 2 by 2 table, of course, this is just the square root of chi-square divided by the number of observations, which is also known as the $\phi $ coefficient.

Cramer’s V varies from 0 (corresponding to no association between the variables) to 1 (complete association) and can reach 1 only when the two variables are equal to each other
```{r}
# cramer v   Sector X CITY OF DESTINATION (top 3)
x<- some_USA$DESTINATION_REGION
y<- some_USA$EMPLOYER_INDUSTRY_SECTOR

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  print.noquote("Cramér V / Phi:")
  return(as.numeric(CV))
}

with(some_USA, cv.test(x, y)) # [1] Cramér V / Phi: 0.1605205


# how about across all cities? (lower) 
x<- both_USA$DESTINATION_REGION
y<- both_USA$EMPLOYER_INDUSTRY_SECTOR

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  print.noquote("Cramér V / Phi:")
  return(as.numeric(CV))
}

with(both_USA, cv.test(x, y)) # [1] Cramér V / Phi:  0.1264835

```

## position  
  
```{r ,fig.width=7, fig.height=7}
#
# mosaicplot(table(some_USA$DESTINATION_REGION, some_USA$POSITION_FUNCTION), ylab = "Political Party", xlab = "Tax Reform Bill Opinion", main = "Opinion vs Party",          color = c("purple", "forestgreen"))

# qplot
qplot(x = DESTINATION_REGION, data = some_USA, fill = POSITION_FUNCTION, geom = "bar") +
theme(axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
  labs(title="POSITION_FUNCTION across top 3 city in 3 countries" , x="", y="Number of people coming in")

# Test statistic (assuming indipendence)
chisq <- chisq.test(x = table(some_USA$DESTINATION_REGION, some_USA$POSITION_FUNCTION), correct = FALSE)
chisq

# ggplot
ggplot(some_USA, aes(x=DESTINATION_REGION, y=NEW_MEM_ID, fill=POSITION_FUNCTION),  colour="black")    +  
  geom_bar(aes(colour =POSITION_FUNCTION),stat="identity", position = "fill" )  +
theme(axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
 labs(title="POSITION_FUNCTION across top 3 city in 3 countries" , x="", y="Number of people coming in normalized")
```



```{r}
# cramer v   POSITION_FUNCTION X CITY OF DESTINATION (top 3)
x<- some_USA$DESTINATION_REGION
y<- some_USA$POSITION_FUNCTION

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  print.noquote("Cramér V / Phi:")
  return(as.numeric(CV))
}

with(some_USA, cv.test(x, y)) # [1] Cramér V / Phi: [1] 0.1318759


# how about across all cities? (lower) 
x<- both_USA$DESTINATION_REGION
y<- both_USA$POSITION_FUNCTION

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  print.noquote("Cramér V / Phi:")
  return(as.numeric(CV))
}

with(both_USA, cv.test(x, y)) # [1] Cramér V / Phi:  [1] 0.07209771

```



5. DOMESTIC MIGRATION

comparative analysis of domestic / patterns of internal migration in each country







