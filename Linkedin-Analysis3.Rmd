---
title: "LinkedIn & IFC study of migration"
author: "Luisa M Mimmi"
date: "November 24, 2017"
output: pdf_document
---

# 1 CONCEPTUAL FRAMEWORK

A city's productivity can be  simply defined as the net result of contrasting forces $\ Productivity = Agglomeration (positive) - Congestion (negative)$ 

Where $\ Agglomeration$ and $\ Congestion$ are a function of various dimensions $\ = f(Skills, Amenities, Form, Access)$

* Dimensions
    + **Skills**, a city’s aggregate stock of human capital
    + **Amenities** - _attracting skills_ - job opportunities, housing values, cultural attractions
    + **Form**, the size and spatial configuration of a city (*density* vs. *sprawl*, *wider metropolitan areas*)
    + **Access**, a city’s connectedness (or barriers) to other cities, both at home and abroad, through the transportation network

* This comparative analysis will focus on the first dimension **Skills**, with hints to the other ones


```{r packages , results='hide', warning=FALSE, message = FALSE}

library(ggplot2) # install.packages("ggplot2")
library(dplyr)
library(knitr)
library(datasets) # initialize
library(knitr)
library(kableExtra)
library(stats)
library(tidyr)
library(stringr)
library(stats)
```

```{r data , results='hide', warning=FALSE, message = FALSE}
# getwd()
# migr <- read.csv("migration.csv",fileEncoding="UTF-8-BOM")
# demog <- read.csv("demographics.csv",fileEncoding="UTF-8-BOM")

load(here::here(".","migr.Rdata"))
load(here::here(".","demog.Rdata"))
```

# 2 DATA EXPLORATION BY COUNTRY

## 2.a Preliminary check on demog and migr
```{r}
#   names(demog)      #see all header (column) names
demog[1:5,]          # Indexing (1st to 5 th rows only)
str(demog)
summary(demog)       #see some summary statistics of each column
#  sapply(demog, class)   # get class of all columns

#   names(migr)      #see all header (column) names
migr[1:5,]          # Indexing (1st to 5 th rows only)
str(migr)
summary(migr)       #see some summary statistics of each column
#  sapply(migr, class)   # get class of all columns     
```

* **INSIGHTs**: 
    + Data contains 347 origin regions and only 282 destinations
    + All Linkedin members (in data) have some tertiary education degree, ~ 50% are Entry level 
    + Linkedin members (in data) are distributed in 14 sectors




#### Merge the 2 tables 
```{r }
both <- left_join(demog,migr, by="NEW_MEM_ID")
```


## 2.b Frequencies and Proportions 
I'm interested in studying members distribution across categorical variables according to origin country

### Percentages and Proportions of _HIGHEST DEGREE_ across countries of origin
```{r  eval=FALSE}
# Single variable 
country <- table(both$SOURCE_COUNTRY)
# Proportions for a single variable table
prop.table(country)

# Cross table by two variables 
xcountry <- xtabs(~ HIGHEST_DEGREE_OBTAINED +SOURCE_COUNTRY, both)
# xcountry
addmargins(xcountry)

# Proportions in Cross Table 
prop.table(xcountry)               # proportion to total
prop.table(xcountry, margin = 1)   # proportion to row sum (DEGREE)
prop.table(xcountry, margin = 2)   # proportion to column sum (ORIGIN COUNTRY)

# Stratified Table 
## 3rd variable as stratified variable
xcountry2 <- xtabs(~ HIGHEST_DEGREE_OBTAINED +SENIORITY +SOURCE_COUNTRY, both)
xcountry2
## flat table
ftable(xcountry2)

```

### Proportions of HIGHEST DEGREE/Seniority/Sector/Position against Country of origin with *Dplyr*  
```{r}
#   Prop of members in each DEGREE to SUM of Country of origin
freq_OrigDegree <- both %>%
  group_by(both[,7],both[,2]) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))
freq_OrigDegree  # 

freq_OrigSniority <- both %>%
  group_by(both[,7],both[,3]) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))
freq_OrigSniority  # % remarkably similar in terms of Seniority  across countries of ORIGIN

freq_OrigSector <- both %>%
  group_by(both[,7],both[,4]) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))
freq_OrigSector  # % remarkably similar in terms of sector across countries

freq_OrigPosition <- both %>%
  group_by(both[,7],both[,5]) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))
freq_OrigPosition  # % remarkably similar in terms of position across countries

```
* **INSIGHTs**: 
    + US has a significantly higher # of Associates leaving (18% vs 3% and 4%)
    + Proportions seem remarkably similar in terms of Seniority / Sector / Position across countries of ORIGIN
    + At the country level there are no big differences... probably makes more sense looking at city or internally
    + Wonder if this is a subset of real Linkedin members or if there are particular similarities in the English-speaking countries
   
   
### Percentages and Proportions - Seniority/Sector/Position against Country of DESTINATION-  with *Dplyr* 
I do the same analysis but looking at DESTINATION
* Very similar results as per Origin 

```{r eval=FALSE}
# prop DEGREE by country orf destin
freq_DestDegree <- both %>%
  group_by(both[,9],both[,2]) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))
freq_DestDegree  # US has a significantly higher # of Associates leaving (18% vs 3% and 4%)

# prop SENIORITY by country orf destin
freq_DestSniority <- both %>%
  group_by(both[,9],both[,3]) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))
freq_DestSniority  # % remarkably similar in terms of Seniority across countries

# prop SECTOR by country orf destin
freq_DestSector <- both %>%
  group_by(both[,9],both[,4]) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))
freq_DestSector  # % remarkably similar in terms of sector across countries

# prop POSITION by country orf destin
freq_DestPosition <- both %>%
  group_by(both[,9],both[,5]) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))
freq_DestPosition  # % remarkably similar in terms of position across countries

# 3-Way Frequency Table 
# mytable <- table(both[,4],both[,2], both[,3]) 
# ftable(mytable)
```

# 3 DATA EXPLORATION BY CITY

#### interim manipulation 
```{r , results='hide', warning=FALSE, message = FALSE}
# create origin table
origin <- both %>% select(id=NEW_MEM_ID, degree=HIGHEST_DEGREE_OBTAINED, seniority=SENIORITY, sector=EMPLOYER_INDUSTRY_SECTOR, role=POSITION_FUNCTION, date=WEEK_BEGINNING, countryO=SOURCE_COUNTRY, cityO=SOURCE_REGION)

# create destination table
destination <- both %>% select(id=NEW_MEM_ID, degree=HIGHEST_DEGREE_OBTAINED, seniority=SENIORITY, sector=EMPLOYER_INDUSTRY_SECTOR, role=POSITION_FUNCTION, date=WEEK_BEGINNING, countryD=DESTINATION_COUNTRY, cityD=DESTINATION_REGION)
```


## 3.1 Top 10 cities  (US)
```{r}
# Aggregate N flow (OUT) by City
library (knitr)
library(kableExtra)
aggreOrig <- origin  %>% 
  group_by(cityO) %>% 
  summarize(NumOutflow= n())  %>% 
  mutate(freq = NumOutflow / sum(NumOutflow)) %>%
  mutate(rel.freq = as.numeric(paste0(round(100 * NumOutflow/sum(NumOutflow), 3))))  %>% 
  arrange(desc(NumOutflow))

# Top 10 ORIGIN cities  
aggreOrig_short <- aggreOrig[1:10,]  
kable(aggreOrig_short, #format = "html", 
      caption = "Ranking of cities by Origin") %>%  kable_styling(bootstrap_options = c("striped", "hover", full_width = T , position = "center",font_size = NULL))

# create destination table
destination <- both %>% select(id=NEW_MEM_ID, degree=HIGHEST_DEGREE_OBTAINED, seniority=SENIORITY, sector=EMPLOYER_INDUSTRY_SECTOR, role=POSITION_FUNCTION, date=WEEK_BEGINNING, countryD=DESTINATION_COUNTRY, cityD=DESTINATION_REGION)


# Aggregate N flow (IN) by City
 library (knitr)
library(kableExtra)
aggreDest <- destination  %>% 
  group_by(cityD) %>% 
  summarize(NumInflow= n())  %>% 
  mutate(freq = NumInflow / sum(NumInflow)) %>%
  mutate(rel.freq = as.numeric(paste0(round(100 * NumInflow/sum(NumInflow), 3))))  %>% 
  arrange(desc(NumInflow))

# Top 10 DESTINATION cities
aggreDest_short <- aggreDest[1:10,]  
kable(aggreDest_short, #format = "html", 
      caption = "Ranking of cities by popular destination") %>% kable_styling(bootstrap_options = c("striped", "hover", full_width = T , position = "center",font_size = NULL))
```
* **INSIGHTs**: 
    + Intristingly, London is # 5 Origin but # 10 Destination
    + 9/10 top DESTINATION are the same as top ORIGIN which suggest there is mobility, but not necessarily the top destination are places where people stay
    + this can be explained by the American way of moving to and from the city of college
    + _those where all american !!!_


## 3.2 Top 10 cities  (UK)
```{r}
# Aggregate N flow (OUT) by City
library (knitr)
library(kableExtra)

# subset origin
originUK <- subset (origin , countryO == "United Kingdom")

aggreOrigUK <- originUK  %>% 
  group_by(cityO) %>% 
  summarize(NumOutflow= n())  %>% 
  mutate(freq = NumOutflow / sum(NumOutflow)) %>%
  mutate(rel.freq = as.numeric(paste0(round(100 * NumOutflow/sum(NumOutflow), 3))))  %>% 
  arrange(desc(NumOutflow))  #%>% left_join(origin, by="cityO")

# Top 10 ORIGIN cities  
aggreOrig_shortUK <- aggreOrigUK[1:10,]  
kable(aggreOrig_shortUK, #format = "html", 
      caption = "Ranking of cities by Origin") %>%  kable_styling(bootstrap_options = c("striped", "hover", full_width = T , position = "center",font_size = NULL))


# ======================================================#

# subset destination
destinationUK <- subset (destination , countryD == "United Kingdom")


# Aggregate N flow (IN) by City
 library (knitr)
library(kableExtra)
aggreDestUK <- destinationUK  %>% 
  group_by(cityD) %>% 
  summarize(NumInflow= n())  %>% 
  mutate(freq = NumInflow / sum(NumInflow)) %>%
  mutate(rel.freq = as.numeric(paste0(round(100 * NumInflow/sum(NumInflow), 3))))  %>% 
  arrange(desc(NumInflow))

# Top 10 DESTINATION cities
aggreDest_shortUK <- aggreDestUK[1:10,]  
kable(aggreDest_shortUK, #format = "html", 
      caption = "Ranking of cities by popular destination") %>% kable_styling(bootstrap_options = c("striped", "hover", full_width = T , position = "center",font_size = NULL))
```
* **INSIGHTs**: 
    + Contrary to widespread mobility in US, London is origin of 28% of migrants and the Destination for 55% of them 
    

## 3.3 Top 10 cities  (Austr)
 
```{r}
# Aggregate N flow (OUT) by City
library (knitr)
library(kableExtra)

# subset origin
originAustr <- subset (origin , countryO == "Australia")

aggreOrigAustr <- originAustr  %>% 
  group_by(cityO) %>% 
  summarize(NumOutflow= n())  %>% 
  mutate(freq = NumOutflow / sum(NumOutflow)) %>%
  mutate(rel.freq = as.numeric(paste0(round(100 * NumOutflow/sum(NumOutflow), 3))))  %>% 
  arrange(desc(NumOutflow))  #%>% left_join(origin, by="cityO")

# Top 10 ORIGIN cities  
aggreOrig_shortAustr <- aggreOrigAustr[1:10,]  
kable(aggreOrig_shortAustr, #format = "html", 
      caption = "Ranking of cities by Origin") %>%  kable_styling(bootstrap_options = c("striped", "hover", full_width = T , position = "center",font_size = NULL))


# ======================================================#

# subset destination
destinationAustr <- subset (destination , countryD == "Australia")


# Aggregate N flow (IN) by City
 library (knitr)
library(kableExtra)
aggreDestAustr <- destinationAustr  %>% 
  group_by(cityD) %>% 
  summarize(NumInflow= n())  %>% 
  mutate(freq = NumInflow / sum(NumInflow)) %>%
  mutate(rel.freq = as.numeric(paste0(round(100 * NumInflow/sum(NumInflow), 3))))  %>% 
  arrange(desc(NumInflow))

# Top 10 DESTINATION cities
aggreDest_shortAustr <- aggreDestAustr[1:10,]  
kable(aggreDest_shortAustr, #format = "html", 
      caption = "Ranking of cities by popular destination") %>% kable_styling(bootstrap_options = c("striped", "hover", full_width = T , position = "center",font_size = NULL))
```
* **INSIGHTs**: 
    + Similar to UK, in Australiam Sydney is the origin of 36% of migrants and the Destination for 50% of them 



## 3.4 Plots of top cities 

#### JOIN the AGGREGATE by CITY to have Net flows in the same table (by City) 
```{r , results='hide', warning=FALSE, message = FALSE}
# Adding some variables for plots  
aggreByCity <- full_join(aggreDest,aggreOrig, by = c("cityD" = "cityO")) 
aggreByCity[c("NumInflow", "NumOutflow")][is.na(aggreByCity[c("NumInflow", "NumOutflow")])] <- 0

aggreByCity <-  aggreByCity %>% 
  select(-freq.x,-rel.freq.x, -freq.y, -rel.freq.y) %>%  # get rid of meeaningless 
  mutate (NetFlow= NumInflow -NumOutflow) %>% # Net 
  mutate (NegOutFlow= -(NumOutflow)) %>% # neg sign 
  mutate (Sign = ifelse(NetFlow > 0, "Positive", "Negative")) %>%
  mutate (colour= ifelse(NetFlow > 0, "positive", "negative")) %>%  mutate (city_copy = cityD)  %>%  
  separate(city_copy, into = c("city_only", "metro area"), sep = ",")

summary(aggreByCity)
  

```


#### interim 
```{r}
# ====================== INTERIM ======================= #
names(aggreByCity)[1]<-"city"
names(migr)[4]<-"city"
# city_country <-full_join(aggreByCity, migr, by = c("city", "SOURCE_REGION")) %>%  # #select(city,country=origCountry)

city_country <-full_join(aggreByCity, migr, by = "city") %>%  
  select(city, country=DESTINATION_COUNTRY) %>%
  distinct () %>% # need the dup flag 
  mutate(dupli = ifelse((city =="Greater New York City Area"|city =="San Francisco Bay Area" |city =="Washington D.C. Metro Area"|
  city =="Greater Los Angeles Area"|city =="Greater Boston Area"|city =="Greater Chicago Area" |
  city =="Dallas/Fort Worth Area" |city =="Greater Seattle Area" |city =="San Francisco Bay Area") & country!="United States", "dup", "")) %>% # need the dup flag 
  
  mutate(dupli2 = ifelse((city =="London, United Kingdom") & country!="United kindom", "dup", "")) %>% # need the dup flag 
  
  mutate(dupli3 = ifelse((city =="Sydney Area, Australia") & country!="Australia", "dup", "")) %>% # need the dup flag 
  
  mutate(dupli4 = ifelse((city =="Perth Area, Australia") & country!="Australia", "dup", "")) %>% # need the dup flag 
  
  mutate(dupli5 = ifelse((city =="Miami/Fort Lauderdale Area") & country!="United States", "dup", "")) %>% # need the dup flag 
  
  mutate(dupli6 = ifelse((city =="Brisbane Area, Australia") & country!="Australia", "dup", "")) 


city_country <- subset(city_country, city_country$dupli!="dup" & city_country$dupli2!="dup" & city_country$dupli3!="dup" & city_country$dupli4!="dup" & city_country$dupli5!="dup" & city_country$dupli6!="dup") %>% select(city, country)


newRow <- data.frame(city ="London, United Kingdom", country ="United Kingdom" )

city_country <- rbind(city_country,newRow)
#city_country <- rbind(city_country, c("London, United Kingdom", "United kindom"))
  
names(aggreByCity)[1]<-"cityD"
# ===================================================== #
```


###  Major 30 (World - mostly US) cities TO people are migrating 

```{r ,fig.width=10, fig.height=7}
names(aggreByCity)[1]<-"city"

# 1) In  Flow in Top DESTINATION 
Top_in <- aggreByCity %>% top_n(30, NumInflow)  
  Top_in$city = with(Top_in, reorder(city,NumInflow)) # reorder Levels by Var

Top_in <- ggplot(data = Top_in,aes(city, NumInflow)) + 
  geom_bar(stat = "identity", position="identity", fill = "steelblue") +
  geom_hline(yintercept=10000, color = "black", size=0.5) +
  theme(axis.text.x = element_text(angle=60, vjust=0.3), axis.text.y = element_text(size=10,face="bold") ) + 
  labs(title="IN migration flow in first 15 destination")


Top_in + coord_flip()

# 2) Out  Flow in Top ORIGIN 
Top_out <- aggreByCity %>% top_n(30, NumOutflow)  
  Top_out$city = with(Top_out, reorder(city,NumOutflow)) # reorder Levels by Var

Top_out <- ggplot(data = Top_out,aes(city, NegOutFlow)) + 
  geom_bar(stat = "identity", position="identity", fill = "firebrick1") + 
   geom_hline(yintercept=-10000, color = "black", size=0.5) +
  theme(axis.text.x = element_text(angle=60, vjust=0.3), axis.text.y = element_text(size=10,face="bold") ) + 
  labs(title="OUT migration flow in first 15 origin") 
  
Top_out + coord_flip()

# plot side by side 
# library(gridExtra)
# grid.arrange(in_flip, out_flip, ncol=2)

# 3.a)  NET flow in Top  DESTINATION 
Top_net <- aggreByCity %>% top_n(30, NumInflow)  
  Top_net$city = with(Top_net, reorder(city,NumInflow)) # reorder Levels by Var

Top_net <- ggplot(data = Top_net,aes(city, NetFlow)) + 
  geom_bar(stat = "identity", position="identity",aes(fill = colour)) + 
  theme(axis.text.x = element_text(angle=60, vjust=0.3), axis.text.y = element_text(size=10,face="bold") ) + 
  scale_fill_manual(values=c(positive="steelblue",negative="firebrick1")) +
  labs(title="NET migration flow in first 25 destination", subtitle="(ordered by destination)")

Top_net + coord_flip()

# 3.b)  NET flow in Top  ORIGIN 
Top_net <- aggreByCity %>% top_n(30, NumOutflow)  
  Top_net$city = with(Top_net, reorder(city,NumOutflow)) # reorder Levels by Var

Top_net <- ggplot(data = Top_net,aes(city, NetFlow)) + 
  geom_bar(stat = "identity", position="identity",aes(fill = colour)) + 
  theme(axis.text.x = element_text(angle=60, vjust=0.3), axis.text.y = element_text(size=10,face="bold") ) + 
  scale_fill_manual(values=c(positive="steelblue",negative="firebrick1")) +
  labs(title="NET migration flow in first 25 origin", subtitle="(ordered by origin)")
Top_net + coord_flip()


# all american
# lots of leaving in 2016 - especially in NY 
```




```{r}
# add country to aggreByCity
aggreByCity2 <- left_join(aggreByCity,city_country,by = "city")

# x[c("a", "b")][is.na(x[c("a", "b")])] <- 0
aggreByCity2[c("NumInflow", "NumOutflow")][is.na(aggreByCity2[c("NumInflow", "NumOutflow")])] <- 0


```


###  Major 20 (UK) cities TO / FROM / NET migration 
```{r}
# 1) In  Flow in Top DESTINATION 

aggreByCityUK <- aggreByCity2 %>% 
  filter (country == "United Kingdom")
 
Top_inUK <- aggreByCityUK %>% 
  top_n(30, NumInflow)  

Top_inUK$city = with(Top_inUK, reorder(city,NumInflow)) # reorder Levels by Var

Top_inUK <- ggplot(data = Top_inUK,aes(city, NumInflow)) + 
  geom_bar(stat = "identity", position="identity", fill = "steelblue") +
  geom_hline(yintercept=10000, color = "black", size=0.5) +
  theme(axis.text.x = element_text(angle=60, vjust=0.3), axis.text.y = element_text(size=10,face="bold") ) + 
  labs(title="IN migration flow in first 15 destination")


Top_inUK + coord_flip()

# 2) Out  Flow in Top ORIGIN 
Top_outUK <- aggreByCityUK %>% 
  filter (country == "United Kingdom") %>% # filter by country = UK 
  top_n(30, NumOutflow)  
  Top_outUK$city = with(Top_outUK, reorder(city,NumOutflow)) # reorder Levels by Var

Top_outUK <- ggplot(data = Top_outUK,aes(city, NegOutFlow)) + 
  geom_bar(stat = "identity", position="identity", fill = "firebrick1") + 
   geom_hline(yintercept=-10000, color = "black", size=0.5) +
  theme(axis.text.x = element_text(angle=60, vjust=0.3), axis.text.y = element_text(size=10,face="bold") ) + 
  labs(title="OUT migration flow in first 15 origin") 
  
Top_outUK + coord_flip()

# 3.a)  NET flow in Top  DESTINATION 
Top_netUK <- aggreByCityUK %>% 
   filter (country == "United Kingdom") %>% # filter by country = UK 
  top_n(30, NumInflow)  
  Top_netUK$city = with(Top_netUK, reorder(city,NumInflow)) # reorder Levels by Var

Top_netUK <- ggplot(data = Top_netUK,aes(city, NetFlow)) + 
  geom_bar(stat = "identity", position="identity",aes(fill = colour)) + 
  theme(axis.text.x = element_text(angle=60, vjust=0.3), axis.text.y = element_text(size=10,face="bold") ) + 
  scale_fill_manual(values=c(positive="steelblue",negative="firebrick1")) +
  labs(title="NET migration flow in first 25 destination", subtitle="(ordered by destination)")
Top_netUK + coord_flip()

# 3.b)  NET flow in Top  ORIGIN 
Top_netUK <- aggreByCityUK %>% 
   filter (country == "United Kingdom") %>% # filter by country = UK 
  top_n(30, NumOutflow)  
  Top_netUK$city = with(Top_netUK, reorder(city,NumOutflow)) # reorder Levels by Var

Top_netUK <- ggplot(data = Top_netUK,aes(city, NetFlow)) + 
  geom_bar(stat = "identity", position="identity",aes(fill = colour)) + 
  theme(axis.text.x = element_text(angle=60, vjust=0.3), axis.text.y = element_text(size=10,face="bold") ) + 
  scale_fill_manual(values=c(positive="steelblue",negative="firebrick1")) +
  labs(title="NET migration flow in first 25 origin", subtitle="(ordered by origin)")
Top_netUK + coord_flip()
```

* **INSIGHTs**: 
    + Contrary to US, London is a definitive outlier
  
###  Major 20 (AUSTRALIA) cities TO / FROM / NET migration  
```{r}
# 1) In  Flow in Top DESTINATION 

aggreByCityAustr <- aggreByCity2 %>% 
  filter (country == "Australia")
 
Top_inAustr <- aggreByCityAustr %>% 
  top_n(30, NumInflow)  

Top_inAustr$city = with(Top_inAustr, reorder(city,NumInflow)) # reorder Levels by Var

Top_inAustr <- ggplot(data = Top_inAustr,aes(city, NumInflow)) + 
  geom_bar(stat = "identity", position="identity", fill = "steelblue") +
  geom_hline(yintercept=10000, color = "black", size=0.5) +
  theme(axis.text.x = element_text(angle=60, vjust=0.3), axis.text.y = element_text(size=10,face="bold") ) + 
  labs(title="IN migration flow in first 15 destination")


Top_inAustr + coord_flip()

# 2) Out  Flow in Top ORIGIN 
Top_outAustr <- aggreByCityAustr %>% 
  filter (country == "Australia") %>% # filter by country = Austr 
  top_n(30, NumOutflow)  
  Top_outAustr$city = with(Top_outAustr, reorder(city,NumOutflow)) # reorder Levels by Var

Top_outAustr <- ggplot(data = Top_outAustr,aes(city, NegOutFlow)) + 
  geom_bar(stat = "identity", position="identity", fill = "firebrick1") + 
   geom_hline(yintercept=-10000, color = "black", size=0.5) +
  theme(axis.text.x = element_text(angle=60, vjust=0.3), axis.text.y = element_text(size=10,face="bold") ) + 
  labs(title="OUT migration flow in first 15 origin") 
  
Top_outAustr + coord_flip()

# 3.a)  NET flow in Top  DESTINATION 
Top_netAustr <- aggreByCityAustr %>% 
   filter (country == "Australia") %>% # filter by country = Austr 
  top_n(30, NumInflow)  
  Top_netAustr$city = with(Top_netAustr, reorder(city,NumInflow)) # reorder Levels by Var

Top_netAustr <- ggplot(data = Top_netAustr,aes(city, NetFlow)) + 
  geom_bar(stat = "identity", position="identity",aes(fill = colour)) + 
  theme(axis.text.x = element_text(angle=60, vjust=0.3), axis.text.y = element_text(size=10,face="bold") ) + 
  scale_fill_manual(values=c(positive="steelblue",negative="firebrick1")) +
  labs(title="NET migration flow in first 25 destination", subtitle="(ordered by destination)")
Top_netAustr + coord_flip()

# 3.b)  NET flow in Top  ORIGIN 
Top_netAustr <- aggreByCityAustr %>% 
   filter (country == "Australia") %>% # filter by country = Austr 
  top_n(30, NumOutflow)  
  Top_netAustr$city = with(Top_netAustr, reorder(city,NumOutflow)) # reorder Levels by Var

Top_netAustr <- ggplot(data = Top_netAustr,aes(city, NetFlow)) + 
  geom_bar(stat = "identity", position="identity",aes(fill = colour)) + 
  theme(axis.text.x = element_text(angle=60, vjust=0.3), axis.text.y = element_text(size=10,face="bold") ) + 
  scale_fill_manual(values=c(positive="steelblue",negative="firebrick1")) +
  labs(title="NET migration flow in first 25 origin", subtitle="(ordered by origin)")
Top_netAustr + coord_flip()

```




# 4 BIVARIATE MEASURES OF ASSOCIATION

## 4.1 INflow by city vs highest degree
Is there any relation between where they choose to go and the highest degree they have? I use plots to check  distributions type of DEGREE (Y) conditional on  the city of destination (X) 

* I check for :
    + *Existence*
    + *strnght*
    + *patterns* / direction 



Greater New York City Area
San Francisco Bay Area
Washington D.C. Metro Area

Manchester, United Kingdom
London, United Kingdom
Birmingham, United Kingdom

Sydney Area, Australia
Brisbane Area, Australia
Canberra Area, Australia



```{r ,fig.width=9, fig.height=9}
# 1) attempt for simplicity I select top 3 per country

#top3 <- both %>% filter(DESTINATION_REGION == "Greater New York City Area" |DESTINATION_REGION =="San Francisco Bay Area" |DESTINATION_REGION =="Washington D.C. Metro Area" | DESTINATION_REGION == "Manchester, United Kingdom" |DESTINATION_REGION =="London, United Kingdom" |DESTINATION_REGION =="Birmingham, United Kingdom" | DESTINATION_REGION == "Sydney Area, Australia" |DESTINATION_REGION =="Brisbane Area, Australia" |DESTINATION_REGION =="Canberra Area, Australia")

# 2) attempt 

# top_subs <- subset(both, (DESTINATION_REGION == 'Greater New York City Area' | DESTINATION_REGION =='San Francisco Bay Area' | DESTINATION_REGION =='Washington D.C. Metro Area' | DESTINATION_REGION == 'Manchester, United Kingdom' | DESTINATION_REGION =='London, United Kingdom' |DESTINATION_REGION =='Birmingham, United Kingdom' | DESTINATION_REGION == 'Sydney Area, Australia' | DESTINATION_REGION =='Brisbane Area, Australia' | DESTINATION_REGION =='Canberra Area, Australia'))


# 3) attempt
# When subsetting with [ names are always matched exactly
# z <- c(abc = 1, def = 2)
# z[c("a", "d")]

top_dest <- c("Greater New York City Area" , "San Francisco Bay Area",  "Washington D.C. Metro Area" , "Manchester, United Kingdom", "London, United Kingdom" ,"Birmingham, United Kingdom" ,"Sydney Area, Australia","Brisbane Area, Australia" ,"Canberra Area, Australia")

 # both_top <- both[as.character(  both$DESTINATION_REGION %in% top_dest), drop = T]

# data[data$Code %in% selected,]
# both_top <- both[both$DESTINATION_REGION %in% top_dest]
# both_top <- both[as.character(  both$DESTINATION_REGION %in% top_dest), drop = TRUE]

# 4) attemps
# data[data$Code == "A" | data$Code == "B", ]
top3cit <- both[both$DESTINATION_REGION == "Greater New York City Area" | both$DESTINATION_REGION == "San Francisco Bay Area"  | both$DESTINATION_REGION == "Washington D.C. Metro Area" | both$DESTINATION_REGION == "Manchester" | both$DESTINATION_REGION == "United Kingdom"| both$DESTINATION_REGION == "London, United Kingdom" | both$DESTINATION_REGION =="Birmingham, United Kingdom" | both$DESTINATION_REGION =="Sydney Area, Australia"| both$DESTINATION_REGION =="Brisbane Area, Australia" | both$DESTINATION_REGION =="Canberra Area, Australia" ,  ]


# 5) attemps
# top_dest <- c("Greater New York City Area" , "San Francisco Bay Area",  "Washington D.C. Metro Area" , "Manchester, United Kingdom", "London, United Kingdom" ,"Birmingham, United Kingdom" ,"Sydney Area, Australia","Brisbane Area, Australia" ,"Canberra Area, Australia")


# top3cit_2 <-  both[both$DESTINATION_REGION %in%  top_dest, , drop =TRUE ]

 # mutate (Sign = ifelse(NetFlow > 0, "Positive", "Negative"))


# Explore 

# mosaicplot(table(top3cit$DESTINATION_REGION, top3cit$HIGHEST_DEGREE_OBTAINED), ylab = "Political Party", xlab = "Tax Reform Bill Opinion", main = "Opinion vs Party",          color = c("purple", "forestgreen"))

# qplot
qplot(x = DESTINATION_REGION, data = top3cit, fill = HIGHEST_DEGREE_OBTAINED, geom = "bar") +
theme(axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +  
  labs(title="Highest degree across top 3 city in 3 countries" , x="", y="Number of people coming in normalized")
# ggplot

#ggplot(data = Best_out,aes(cityD, NegOutFlow)) + 
#  geom_bar(stat = "identity", position="identity", fill = "firebrick1") + 
#   geom_hline(yintercept=-10000, color = "black", size=0.5) +
#  theme(axis.text.x = element_text(angle=60, vjust=0.3)) + 
#  labs(title="OUT migration flow in first 15 destination") 


ggplot(top3cit, aes(x=DESTINATION_REGION, y=NEW_MEM_ID, fill=HIGHEST_DEGREE_OBTAINED)) +  
  geom_bar(aes(colour =HIGHEST_DEGREE_OBTAINED),stat="identity", position = "fill") +
  theme(axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
  labs(title="Highest degree across top 3 city in 3 countries" , x="", y="Number of people coming in normalized") 


```

* **INSIGHTs**: 
    + Intuitively, it would seem San Francisco (follwed by Canberra) attracts the highest amount of doctors (Canberra also the highest group with master) 
    + NY, San Francisco and Washington DC seem to receive many with "Associate" level: either young people go tehre to look for tehir first job
    

```{r}
# cramer v   degree  X CITY OF DESTINATION (top 3)
x<- top3cit$DESTINATION_REGION
y<- top3cit$HIGHEST_DEGREE_OBTAINED

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  print.noquote("Cramér V / Phi:")
  return(as.numeric(CV))
}

with(top3cit, cv.test(x, y)) # [1] Cramér V / Phi: 0.09052046
```



```{r ,fig.width=7, fig.height=7}
#
# mosaicplot(table(top3cit$DESTINATION_REGION, top3cit$SENIORITY), ylab = "Political Party", xlab = "Tax Reform Bill Opinion", main = "Opinion vs Party",          color = c("purple", "forestgreen"))

# qplot
qplot(x = DESTINATION_REGION, data = top3cit, fill = SENIORITY, geom = "bar") +
theme(axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
  labs(title="SENIORITY across top 3 city in 3 countries")

# Test statistic (assuming indipendence)
chisq <- chisq.test(x = table(top3cit$DESTINATION_REGION, top3cit$SENIORITY), correct = FALSE)
chisq

# ggplot
ggplot(top3cit, aes(x=DESTINATION_REGION, y=NEW_MEM_ID, fill=SENIORITY)) +  geom_bar(aes(colour =SENIORITY),stat="identity", position = "fill") +
theme(axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
  labs(title="SENIORITY across top 3 city in 3 countries")


```
* **INSIGHTs**: 
    + Intuitively, it would seem San Francisco (follwed by Canberra) attracts the highest amount of doctors (Canberra also the highest group with master) 
    + NY, San Francisco and Washington DC seem to receive many with "Associate" level: either young people go tehre to look for tehir first job
```{r}
# cramer v   SENIORITY   X CITY OF DESTINATION (top 3)
x<- top3cit$DESTINATION_REGION
y<- top3cit$SENIORITY

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  print.noquote("Cramér V / Phi:")
  return(as.numeric(CV))
}

with(top3cit, cv.test(x, y)) # [1] Cramér V / Phi: 0.04360073
```  

```{r ,fig.width=7, fig.height=7}
#
# mosaicplot(table(top3cit$DESTINATION_REGION, top3cit$EMPLOYER_INDUSTRY_SECTOR), ylab = "Political Party", xlab = "Tax Reform Bill Opinion", main = "Opinion vs Party",          color = c("purple", "forestgreen"))

# qplot
qplot(x = DESTINATION_REGION, data = top3cit, fill = EMPLOYER_INDUSTRY_SECTOR, geom = "bar") +
theme(axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
 labs(title="EMPLOYER_INDUSTRY_SECTOR across top 3 city in 3 countries", x="", y="Number of people coming in")



# ggplot
library(RColorBrewer)
display.brewer.all()

ggplot(top3cit, aes(x=DESTINATION_REGION, y=NEW_MEM_ID, fill=EMPLOYER_INDUSTRY_SECTOR)) +  
  geom_bar(aes(colour =EMPLOYER_INDUSTRY_SECTOR),stat="identity",  position = "fill") +
theme(legend.position = "right"    ,axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
  
   # scale_fill_brewer(palette = "Dark2") +
  # scale_fill_grey() +
  labs(title="EMPLOYER_INDUSTRY_SECTOR across top 3 city in 3 countries", x="", y="Number of people coming in normalized")
```

* **INSIGHTs**: 
    + Intuitively, share of immigratns by sector seems to vary a lot in different cities
    + Extremely high number in Govv/ Educ/ Non Profit in Canberra & Washington
    + Extremely high number in Software + Hardware Technology in San Francisco
    + Extremely high number in Govv/ Educ/ Non Profit + Financial sErvices also in NY
    it would seem San Francisco (follwed by Canberra) attracts the highest amount of doctors (Canberra also the highest group with master) 
    + NY, San Francisco and Washington DC seem to receive many with "Associate" level: either young people go tehre to look for tehir first job
  
  
### CHECK A COUPLE OF CITIES FOR SECTOR X SEIORITY
```{r}
freq_OrigDegree <- both %>%
  group_by(both[,7],both[,2]) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))
freq_OrigDegree  # US has a significantly higher # of Associates leaving (18% vs 3% and 4%)
```

##### Cramer's V
 a measure of association for nominal variables. Effectively it is the Pearson chi-square statistic rescaled to have values between 0 and 1, as follows:

$$\phi_{c}=\sqrt{\frac{\chi^2}{N*(min(ncols, nrows)-1)}} $$
where X^2 is the Pearson chi-square, nobs represents the number of observations included in the table, and where ncols and nrows are the number of rows and columns in the table, respectively.

For a 2 by 2 table, of course, this is just the square root of chi-square divided by the number of observations, which is also known as the $\phi$ coefficient.

Cramer’s V varies from 0 (corresponding to no association between the variables) to 1 (complete association) and can reach 1 only when the two variables are equal to each other
```{r}
# cramer v   Sector X CITY OF DESTINATION (top 3)
x<- top3cit$DESTINATION_REGION
y<- top3cit$EMPLOYER_INDUSTRY_SECTOR

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  print.noquote("Cramér V / Phi:")
  return(as.numeric(CV))
}

with(top3cit, cv.test(x, y)) # [1] Cramér V / Phi: 0.1605205


# how about across all cities? (lower) 
x<- both$DESTINATION_REGION
y<- both$EMPLOYER_INDUSTRY_SECTOR

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  print.noquote("Cramér V / Phi:")
  return(as.numeric(CV))
}

with(both, cv.test(x, y)) # [1] Cramér V / Phi:  0.1264835

```

## position  
  
```{r ,fig.width=7, fig.height=7}
#
# mosaicplot(table(top3cit$DESTINATION_REGION, top3cit$POSITION_FUNCTION), ylab = "Political Party", xlab = "Tax Reform Bill Opinion", main = "Opinion vs Party",          color = c("purple", "forestgreen"))

# qplot
qplot(x = DESTINATION_REGION, data = top3cit, fill = POSITION_FUNCTION, geom = "bar") +
theme(axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
  labs(title="POSITION_FUNCTION across top 3 city in 3 countries" , x="", y="Number of people coming in")

# Test statistic (assuming indipendence)
chisq <- chisq.test(x = table(top3cit$DESTINATION_REGION, top3cit$POSITION_FUNCTION), correct = FALSE)
chisq

# ggplot
ggplot(top3cit, aes(x=DESTINATION_REGION, y=NEW_MEM_ID, fill=POSITION_FUNCTION),  colour="black")    +  
  geom_bar(aes(colour =POSITION_FUNCTION),stat="identity", position = "fill" )  +
theme(axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
 labs(title="POSITION_FUNCTION across top 3 city in 3 countries" , x="", y="Number of people coming in normalized")
```



```{r}
# cramer v   POSITION_FUNCTION X CITY OF DESTINATION (top 3)
x<- top3cit$DESTINATION_REGION
y<- top3cit$POSITION_FUNCTION

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  print.noquote("Cramér V / Phi:")
  return(as.numeric(CV))
}

with(top3cit, cv.test(x, y)) # [1] Cramér V / Phi: [1] 0.1318759


# how about across all cities? (lower) 
x<- both$DESTINATION_REGION
y<- both$POSITION_FUNCTION

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  print.noquote("Cramér V / Phi:")
  return(as.numeric(CV))
}

with(both, cv.test(x, y)) # [1] Cramér V / Phi:  [1] 0.07209771

```



# 5. DOMESTIC MIGRATION

comparative analysis of domestic / patterns of internal migration in each country

I will focus on the sector per city which seems the most significant bivariate association

#### construct different samples
```{r}
# select only USA
both_USA <- both %>% filter(SOURCE_COUNTRY=="United States" & DESTINATION_COUNTRY=="United States")

# select only Australia
both_AUS <- both %>% filter(SOURCE_COUNTRY=="Australia" & DESTINATION_COUNTRY=="Australia")

# select only UK
both_UK <- both %>% filter(SOURCE_COUNTRY=="United Kingdom" & DESTINATION_COUNTRY=="United Kingdom")
```

#### construct USA internal sub-sample (for simplicity)
```{r}
both_USA_N <- both_USA %>% group_by(DESTINATION_REGION) %>%  summarise(numIMM = n())
both_USA_N

some_USA <- both_USA[both_USA$DESTINATION_REGION == "Greater New York City Area" | both_USA$DESTINATION_REGION == "San Francisco Bay Area"  | both_USA$DESTINATION_REGION == "Washington D.C. Metro Area" | both_USA$DESTINATION_REGION == "Greater Los Angeles Area" | both_USA$DESTINATION_REGION == "Greater Boston Area"| both_USA$DESTINATION_REGION == "Greater Seattle Area" | both_USA$DESTINATION_REGION =="Austin, Texas Area" | both_USA$DESTINATION_REGION =="Miami/Fort Lauderdale Area"| both_USA$DESTINATION_REGION =="Hawaiian Islands" | both_USA$DESTINATION_REGION =="Savannah, Georgia Area" 
                    | both_USA$DESTINATION_REGION == "Green Bay, Wisconsin Area" | both_USA$DESTINATION_REGION =="St. Cloud, Minnesota Area" | both_USA$DESTINATION_REGION =="Greenville, North Carolina Area"| both_USA$DESTINATION_REGION =="Houston, Texas Area" | both_USA$DESTINATION_REGION =="Savannah, Georgia Area" 
                    ,  ]

summary(some_USA)
```


## 5.1 Bivariate measures of assiciation USA - sector
```{r ,fig.width=7, fig.height=7}
# qplot for visualization
qplot(x = DESTINATION_REGION, data = some_USA, fill = EMPLOYER_INDUSTRY_SECTOR, geom = "bar") +
theme(axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
 labs(title="SECTOR across various US cities", x="", y="Number of people coming in")

# ggplot
ggplot(some_USA, aes(x=DESTINATION_REGION, y=NEW_MEM_ID, fill=EMPLOYER_INDUSTRY_SECTOR)) +  
  geom_bar(aes(colour =EMPLOYER_INDUSTRY_SECTOR),stat="identity",  position = "fill") +
theme(legend.position = "right"    ,axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
  
   # scale_fill_brewer(palette = "Dark2") +
  # scale_fill_grey() +
  labs(title="SECTOR across various US cities", x="", y="Number of people coming in normalized")

# cramer v   Sector X CITY OF DESTINATION (top 3)
x<- some_USA$DESTINATION_REGION
y<- some_USA$EMPLOYER_INDUSTRY_SECTOR

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  print.noquote("Cramér V / Phi:")
  return(as.numeric(CV))
}

with(some_USA, cv.test(x, y)) # [1] Cramér V / Phi: 0.127 (less )

```

## 5.2 Bivariate measures of association AUSTRALIA - sector
```{r ,fig.width=7, fig.height=7}
# qplot for visualization
qplot(x = DESTINATION_REGION, data = both_AUS, fill = EMPLOYER_INDUSTRY_SECTOR, geom = "bar") +
theme(axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
 labs(title="SECTOR across AUS cities", x="", y="Number of people coming in")

# ggplot
ggplot(both_AUS, aes(x=DESTINATION_REGION, y=NEW_MEM_ID, fill=EMPLOYER_INDUSTRY_SECTOR)) +  
  geom_bar(aes(colour =EMPLOYER_INDUSTRY_SECTOR),stat="identity",  position = "fill") +
theme(legend.position = "right"    ,axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
  
   # scale_fill_brewer(palette = "Dark2") +
  # scale_fill_grey() +
  labs(title="SECTOR across AUS cities", x="", y="Number of people coming in normalized")

# cramer v   Sector X CITY OF DESTINATION (top 3)
x<- both_AUS$DESTINATION_REGION
y<- both_AUS$EMPLOYER_INDUSTRY_SECTOR

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  print.noquote("Cramér V / Phi:")
  return(as.numeric(CV))
}

with(both_AUS, cv.test(x, y)) # [1] Cramér V / Phi: 0.127 (less )

```

## 5.3 Bivariate measures of association UK  - sector

#### construct UK internal sub-sample (for simplicity)
```{r}
both_UK_N <- both_UK %>% group_by(DESTINATION_REGION) %>%  summarise(numIMM = n())
both_UK_N

some_UK <- both_UK[both_UK$DESTINATION_REGION == "London, United Kingdom" | both_UK$DESTINATION_REGION == "Edinburgh, United Kingdom"  | both_UK$DESTINATION_REGION == "Cambridge, United Kingdom" | both_UK$DESTINATION_REGION == "Oxford, United Kingdom" | both_UK$DESTINATION_REGION == "Glasgow, United Kingdom"| both_UK$DESTINATION_REGION == "Twickenham, United Kingdom" | both_UK$DESTINATION_REGION =="Coventry, United Kingdom" | both_UK$DESTINATION_REGION =="Harrow, United Kingdom"| both_UK$DESTINATION_REGION =="Cardiff, United Kingdom" | both_UK$DESTINATION_REGION =="Hemel Hempstead, United Kingdom" 
                    | both_UK$DESTINATION_REGION == "Bromley, United Kingdom" | both_UK$DESTINATION_REGION =="Stockport, United Kingdom" | both_UK$DESTINATION_REGION =="Chelmsford, United Kingdom"| both_UK$DESTINATION_REGION =="Stevenage, United Kingdom" | both_UK$DESTINATION_REGION =="Belfast, United Kingdom" 
                    ,  ]

summary(some_UK)
```





```{r ,fig.width=7, fig.height=7}
# qplot for visualization
qplot(x = DESTINATION_REGION, data = some_UK, fill = EMPLOYER_INDUSTRY_SECTOR, geom = "bar") +
theme(axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
 labs(title="SECTOR across some UK cities", x="", y="Number of people coming in")

# ggplot
ggplot(some_UK, aes(x=DESTINATION_REGION, y=NEW_MEM_ID, fill=EMPLOYER_INDUSTRY_SECTOR)) +  
  geom_bar(aes(colour =EMPLOYER_INDUSTRY_SECTOR),stat="identity",  position = "fill") +
theme(legend.position = "right"    ,axis.text.x = element_text(angle=75, vjust=0.3), axis.text.y = element_text(size=10,face="bold") )  +
  
   # scale_fill_brewer(palette = "Dark2") +
  # scale_fill_grey() +
  labs(title="SECTOR across some UK cities", x="", y="Number of people coming in normalized")

# cramer v   Sector X CITY OF DESTINATION (top 3)
x<- some_UK$DESTINATION_REGION
y<- some_UK$EMPLOYER_INDUSTRY_SECTOR

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  print.noquote("Cramér V / Phi:")
  return(as.numeric(CV))
}

with(some_UK, cv.test(x, y)) # [1] Cramér V / Phi: 0.127 (less )

```