---
title: "Linkedin & IFC study of migration"
author: "Luisa M Mimmi"
date: "November 24, 2017"
output:
  pdf_document: default
  html_document: default
---


## Uploading data
## Understanding data
 * Data Exploration 
    + [*Tutorials for learning R*](https://www.r-bloggers.com/how-to-learn-r-2/) Dimensionality
    + [*Quick R*](http://www.statmethods.net/) Defining Data Types
    + [*R for Data Science*](http://r4ds.had.co.nz/) Putting it Together
  
* Restructuring data ??
    + Mapping to a Different Scale
    + **dplyr** Selecting Subsets
    + Scaling and Normalizing
    + **dplyr**  Aggregating

* key variables visualization

## Big Picture 
    + Formulating research question(s)
*comparative analysis of domestic and international migration for the USA, UK and Australia during 2016. *
*This analysis should look at the patterns of internal migration in each country, the relationships between each country in terms of migration and the characteristics of the migration inflow and outflow. *
    + Framework 
    + Insights from existing dataset

## Further questions and next steps
## Consulted reference

======================================================================================================

## Uploading data


```{r packages}
# install.packages("ggplot2")
library(ggplot2)
library(dplyr)
library(knitr)
library(datasets) # initialize
library(help=datasets) # display the datasets

```


```{r data}
getwd()
migr <- read.csv("migration.csv",fileEncoding="UTF-8-BOM")
demog <- read.csv("demographics.csv",fileEncoding="UTF-8-BOM")
```

## Understanding data
```{r}
names(demog)  #see all header (column) names
head(demog)  #see the headers plus the first six rows of data within each header
summary(demog)  #see some summary statistics of each column
str(demog)
class(demog)
sapply(demog, class)# get class of all columns

# Frequency categ var
table(demog[,2]) 
table(demog[,3]) # only 5 unknown seniority 
table(demog[,4])
table(demog[,5])

table(demog[,4],demog[,2])

# 3-Way Frequency Table 
mytable <- table(demog[,4],demog[,2], demog[,3]) 
ftable(mytable)

# margin.table(demog[,1],demog[,2])


# fix(demog)  #open an excel-esque data editor 
      


```



## preliminary check on migr
```{r}
names(migr)  #see all header (column) names
head(migr)  #see the headers plus the first six rows of data within each header
tail (migr) 
summary(migr)  #see some summary statistics of each column
# fix(demog)  #open an excel-esque data editor       

table(migr[,2]) 
table(migr[,3]) # only 5 unknown seniority 
table(migr[,4])
table(migr[,5])
```


# Combine the 2 
```{r}
both <- left_join(demog,migr, by="NEW_MEM_ID")


# CHECK Proportions by source country
table(both[,7],both[,2])

# now with freq
mtcars %>%
  group_by(am, gear) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n))

# freq  bycountry orf origin
freq_OrigDegree <- both %>%
  group_by(both[,7],both[,2]) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))
freq_OrigDegree  # US has a significantly higher # of Associates leaving (18% vs 3% and 4%)

freq_OrigSniority <- both %>%
  group_by(both[,7],both[,3]) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))
freq_OrigSniority  # % remarkably similar in terms of Seniority across countries

freq_OrigSector <- both %>%
  group_by(both[,7],both[,4]) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))
freq_OrigSector  # % remarkably similar in terms of sector across countries

freq_OrigPosition <- both %>%
  group_by(both[,7],both[,5]) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))
freq_OrigPosition  # % remarkably similar in terms of position across countries

# freq  bycountry orf destin
freq_DestDegree <- both %>%
  group_by(both[,9],both[,2]) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))
freq_DestDegree  # US has a significantly higher # of Associates leaving (18% vs 3% and 4%)

freq_DestSniority <- both %>%
  group_by(both[,9],both[,3]) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))
freq_DestSniority  # % remarkably similar in terms of Seniority across countries

freq_DestSector <- both %>%
  group_by(both[,9],both[,4]) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))
freq_DestSector  # % remarkably similar in terms of sector across countries

freq_DestPosition <- both %>%
  group_by(both[,9],both[,5]) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))
freq_DestPosition  # % remarkably similar in terms of position across countries

# 3-Way Frequency Table 
mytable <- table(both[,4],both[,2], both[,3]) 
ftable(mytable)


## conclusion: at the country level there are no big differences... probably makes more sense looking at city or internally 
```



## let's look at the city level
```{r eval=FALSE}
# are orig and destin the same list?
CitiesOrig <- both %>% table(both[,8]) %>%
  mutate(freq = n / sum(n)) %>%
  mutate(rel.freq = paste0(round(100 * n/sum(n), 2), "%"))


# ranking by city with most arrives
summary_monthly_temp <- weather %>% 
  group_by(month) %>% 
  summarize(mean = mean(temp, na.rm = TRUE), 
            std_dev = sd(temp, na.rm = TRUE))
kable(summary_monthly_temp)

```


## LOOK at PROFILE by DESTINATION CITY
```{r}
destination <- both %>% select(id=NEW_MEM_ID, degree=HIGHEST_DEGREE_OBTAINED, seniority=SENIORITY, sector=EMPLOYER_INDUSTRY_SECTOR, role=POSITION_FUNCTION, date=WEEK_BEGINNING, countryD=DESTINATION_COUNTRY, cityD=DESTINATION_REGION)


# Aggregate N flow (in ) by City
 library (knitr)
library(kableExtra)
aggreDest <- destination  %>% 
  group_by(cityD) %>% 
  summarize(NumInflow= n())  %>% 
  mutate(freq = NumInflow / sum(NumInflow)) %>%
  mutate(rel.freq = as.numeric(paste0(round(100 * NumInflow/sum(NumInflow), 3))))  %>% 
  arrange(desc(NumInflow))

  
#kable(aggreDest, format = "html", caption = "Ranking of cities by popular destination") %>% kable_styling(bootstrap_options = c("striped", "hover", full_width = T , position = "center",font_size = NULL))

```


## LOOK at PROFILE by ORIGIN CITY
```{r}
origin <- both %>% select(id=NEW_MEM_ID, degree=HIGHEST_DEGREE_OBTAINED, seniority=SENIORITY, sector=EMPLOYER_INDUSTRY_SECTOR, role=POSITION_FUNCTION, date=WEEK_BEGINNING, countryO=SOURCE_COUNTRY, cityO=SOURCE_REGION)


# Aggregate N flow (OUT ) by City
 library (knitr)
library(kableExtra)
aggreOrig <- origin  %>% 
  group_by(cityO) %>% 
  summarize(NumOutflow= n())  %>% 
  mutate(freq = NumOutflow / sum(NumOutflow)) %>%
  mutate(rel.freq = as.numeric(paste0(round(100 * NumOutflow/sum(NumOutflow), 3))))  %>% 
  arrange(desc(NumOutflow))

  
# kable(aggreOrig, format = "html", caption = "Ranking of cities by Origin") %>%  kable_styling(bootstrap_options = c("striped", "hover", full_width = T , position = "center",font_size = NULL))

```


## JOIN the AGGREGATE by CITY
```{r}
# aggiungo variablili 
aggreByCity <- full_join(aggreDest,aggreOrig, by = c("cityD" = "cityO")) %>%
  mutate (NetFlow= NumInflow -NumOutflow) %>%
  mutate (NegOutFlow= -(NumOutflow)) %>%
  mutate (Sign = ifelse(NetFlow > 0, "Positive", "Negative")) %>%
  mutate (colour= ifelse(NetFlow > 0, "positive", "negative"))

library(ggplot2)
require(ggplot2)
library(stats)
```

##  looking at the cities TO  which more people are running

```{r}
# 2) In  Flow in Best dest 
Best_in <- aggreByCity %>% 
  
  top_n(30, NumInflow)  
  Best_in$cityD = with(Best_in, reorder(cityD,NumInflow)) # reorder Levels by Var

Best_in <- ggplot(data = Best_in,aes(cityD, NumInflow)) + 
  geom_bar(stat = "identity", position="identity", fill = "steelblue") +
  geom_hline(yintercept=10000, color = "black", size=0.5) +
  theme(axis.text.x = element_text(angle=60, vjust=0.3), axis.text.y = element_text(size=10,face="bold") ) + 
  labs(title="IN migration flow in first 15 destination")


Best_in + coord_flip()

# 3) Out  Flow in Best dest 
Best_out <- aggreByCity %>% top_n(30, NumInflow)  
  Best_out$cityD = with(Best_out, reorder(cityD,NumInflow)) # reorder Levels by Var

Best_out <- ggplot(data = Best_out,aes(cityD, NegOutFlow)) + 
  geom_bar(stat = "identity", position="identity", fill = "firebrick1") + 
   geom_hline(yintercept=-10000, color = "black", size=0.5) +
  theme(axis.text.x = element_text(angle=60, vjust=0.3)) + 
  labs(title="OUT migration flow in first 15 destination") 
  
Best_out + coord_flip()

# 1)  NET flow in Best dest 
Best_net <- aggreByCity %>% top_n(30, NumInflow)  
  Best_net$cityD = with(Best_net, reorder(cityD,NumInflow)) # reorder Levels by Var

Best_net <- ggplot(data = Best_net,aes(cityD, NetFlow)) + 
  geom_bar(stat = "identity", position="identity",aes(fill = colour)) + 
  theme(axis.text.x = element_text(angle=60, vjust=0.3)) + 
  scale_fill_manual(values=c(positive="steelblue",negative="firebrick1")) +
  labs(title="Net migration flow in first 25 destination")
Best_net + coord_flip()


# all american
# lots of leaving in 2016 - especially in NY 

```


## same but looking at the cities from which more people are running

```{r}

# 1) In  Flow in Worst dest 
Worst_in <- aggreByCity %>% top_n(30, NumOutflow)  
  Worst_in$cityD = with(Worst_in, reorder(cityD,NumOutflow)) # reorder Levels by Var

Worst_in <- ggplot(data = Worst_in,aes(cityD, NumOutflow)) + 
  geom_bar(stat = "identity", position="identity", fill = "steelblue") + 
   geom_hline(yintercept=10000, color = "black", size=0.5) +
  theme(axis.text.x = element_text(angle=60, vjust=0.3), axis.text.y = element_text(size=10,face="bold") ) + 
  labs(title="IN migration flow in first 30 ORIGIN cities")

Worst_in + coord_flip()

# 2) Out  Flow in Worst dest 
Worst_out <- aggreByCity %>% top_n(30, NumOutflow)  
  Worst_out$cityD = with(Worst_out, reorder(cityD,NumOutflow)) # reorder Levels by Var

Worst_out <- ggplot(data = Worst_out,aes(cityD, NegOutFlow)) + 
  geom_bar(stat = "identity", position="identity", fill = "firebrick1") + 
    geom_hline(yintercept=-10000, color = "black", size=0.5) +
  theme(axis.text.x = element_text(angle=60, vjust=0.3)) + 
  labs(title="OUT migration flow in first 30 ORIGIN cities") 
  
Worst_out + coord_flip()

# 3)  NET flow in Worst dest 
Worst_net <- aggreByCity %>% top_n(30, NumOutflow)  
  Worst_net$cityD = with(Worst_net, reorder(cityD,NumOutflow)) # reorder Levels by Var

Worst_net <- ggplot(data = Worst_net,aes(cityD, NetFlow)) + 
  geom_bar(stat = "identity", position="identity",aes(fill = colour)) + 
  theme(axis.text.x = element_text(angle=60, vjust=0.3)) + 
  scale_fill_manual(values=c(positive="steelblue",negative="firebrick1")) +
  labs(title="Net migration flow in first 30 ORIGIN cities")
Worst_net + coord_flip()


# all american
# lots of leaving in 2016 - especially in NY 

```




Now use this new data frame for plotting. As proportions are already calculated - provided them as y values and added stat="identity" inside the geom_bar.

ggplot(df.new,aes(LetterGrade,prop,fill=ExperimentCohort))+
  geom_bar(stat="identity",position='dodge')
  
  


##  Looking closely at Members demographics 
```{r demog var}
demog %>% group_by (HIGHEST_DEGREE_OBTAINED) %>% summarise(n = n_distinct(NEW_MEM_ID)) %>% arrange(desc(n)) 
demog %>% group_by (SENIORITY) %>% summarise(n = n_distinct(NEW_MEM_ID)) %>% arrange(desc(n)) # 
demog %>% group_by (EMPLOYER_INDUSTRY_SECTOR) %>% summarise(n = n_distinct(NEW_MEM_ID)) %>% arrange(desc(n))
demog %>% group_by (POSITION_FUNCTION) %>% summarise(n = n_distinct(NEW_MEM_ID)) %>% arrange(desc(n))

252952/475316 # 53% has BA
220187/475316 # 46% is entry level
  85999 /475316 # 18% Government/Education/Non-profit	`
  65725 /475316 # followed by 14% Technology - Software
  63281 /475316 # followed by 13% Healthcare & Pharmaceutical				
  60623/475316 # followed by 13% Professional Services		
53792/475316 # 11% is in "Enginireeng" funciton 

```

###  Frequency distribution of members' `highest degree` & `Seniority` by `sector`

```{r}
degree_sector <- demog %>%  
                group_by (Sector=EMPLOYER_INDUSTRY_SECTOR, Degree=HIGHEST_DEGREE_OBTAINED) %>% 
                summarise(N_id=n_distinct(NEW_MEM_ID)) %>% 
                mutate(freq = N_id / sum(N_id)) %>% 
                arrange(Sector, desc(N_id))
kable (degree_sector)

# Which sectors have a strange distribution? 

  # 1) Government/Education/Non-profit + Healthcare & Pharmaceutical + Technology - Hardware have > 13% doctors (other all below 6%)
  # 2) Technology - Hardware  + Technology - Software +  Government/Education/Non-profit have > 25% masters 

seniority_sector <- demog %>%  
                group_by (Sector=EMPLOYER_INDUSTRY_SECTOR, Seniority=SENIORITY) %>% 
                summarise(N_id=n_distinct(NEW_MEM_ID)) %>% 
                mutate(freq = N_id / sum(N_id)) %>% 
                arrange(Sector, desc(N_id))
kable (seniority_sector)

  # 3) Very few people have the Seniority level "Owner" (less than 1% across sectors) which mean that either all work in public -owned companies or if they are start-up they don't use the title ownler or not theee ??


```
### Faceting = create small multiples of the same plot over a different categorical variable.
```{r eval= FALSE}

dat <- degree_sector %>% filter(Sector == "Technology - Hardware" ) 
g1<- ggplot(data = dat, mapping = aes (x=Degree, y=N_id))   +   geom_bar(stat="identity", fill="steelblue") + 
  theme_minimal() 

g1


g2 <- 
  
  with (degree_sector, table(Sector, Degree))
  ggplot(degree_sector, aes(x = Sector, fill = Degree)) + geom_bar()
g2


due <- degree_sector %>% filter(Sector == "Technology - Hardware" | Sector == "Technology - Software") 
g3<- ggplot(due, aes(x = Sector, y= N_id ,fill = Degree)) + geom_bar()
g3


# Histogram on a categorical variable
theme_set(theme_classic())

# Histogram on a Categorical variable

g <- ggplot(demog, aes(x= EMPLOYER_INDUSTRY_SECTOR))
g + geom_bar(aes(fill=HIGHEST_DEGREE_OBTAINED), width = 0.5) + 
  theme(axis.text.x = element_text(angle=65, vjust=0.6)) + 
  labs(title="Histogram on Categorical Variable", 
       subtitle="Degree across Sector") 



```
g2<- ggplot(data = degree_sector, mapping = aes (x=Degree, y=N_id))   +   geom_bar(stat="identity", fill="steelblue")
  +  facet_wrap(~ Degree)
g2




### Per fare una tavola di riassunto [here](https://cran.r-project.org/web/packages/qwraps2/vignettes/summary-statistics.html/)  
https://cran.r-project.org/web/packages/qwraps2/vignettes/summary-statistics.html


##  Defining Data Types
##  Putting it Together

# Restructuring data
## Mapping to a Different Scale
## Selecting Subsets
## Scaling and Normalizing
## Aggregating

















































































































### Find me here
[Linkedin](https://twitter.com/LuisaMimmi/)  

### web link
http://www.statpower.net/Content/310/R%20Stuff/SampleMarkdown.html

### Formulas
### In line formulas
This summation expression $\sum_{i=1}^n X_i$ appears inline.

### Displayed formulas
$$\sum_{i=1}^n X_i$$